# metabase_screenshot_service.py
from flask import Flask, request, jsonify, send_file
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException
import base64
import time
import io
from datetime import datetime

app = Flask(__name__)

class MetabaseScreenshotService:
    def __init__(self):
        self.chrome_options = Options()
        self.chrome_options.add_argument("--headless")
        self.chrome_options.add_argument("--no-sandbox")
        self.chrome_options.add_argument("--disable-dev-shm-usage")
        self.chrome_options.add_argument("--disable-gpu")
        self.chrome_options.add_argument("--window-size=1400,1000")
        self.chrome_options.add_argument("--disable-extensions")
        # Ïã§Ï†ú Î∏åÎùºÏö∞Ï†ÄÏ≤òÎüº User-Agent ÏÑ§Ï†ï
        self.chrome_options.add_argument("--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36")
        
    def wait_for_dynamic_elements(self, driver, max_wait=30):
        """JavaScript ÎèôÏ†Å Î†åÎçîÎßÅ ÏôÑÎ£åÍπåÏßÄ ÎåÄÍ∏∞"""
        print("‚è≥ ÎèôÏ†Å Ïª®ÌÖêÏ∏† Î°úÎî© ÎåÄÍ∏∞ Ï§ë...")
        
        # 1. ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å ÎåÄÍ∏∞
        WebDriverWait(driver, 10).until(
            lambda d: d.execute_script("return document.readyState") == "complete"
        )
        
        # 2. JavaScript Ïã§Ìñâ Ï∂îÍ∞Ä ÎåÄÍ∏∞
        time.sleep(5)
        
        # 3. JavaScriptÎ°ú Î°úÍ∑∏Ïù∏ Ìèº Ï°¥Ïû¨ ÌôïÏù∏
        wait_script = """
        return new Promise((resolve) => {
            let attempts = 0;
            const maxAttempts = 100;
            
            function checkForLoginForm() {
                attempts++;
                
                const selectors = [
                    'input[name="username"]',
                    'input[name="email"]', 
                    'input[type="text"]',
                    'input[type="email"]',
                    'input[placeholder*="username" i]',
                    'input[placeholder*="email" i]'
                ];
                
                for (let selector of selectors) {
                    const element = document.querySelector(selector);
                    if (element && element.offsetParent !== null) {
                        resolve({
                            found: true,
                            selector: selector
                        });
                        return;
                    }
                }
                
                if (attempts < maxAttempts) {
                    setTimeout(checkForLoginForm, 300);
                } else {
                    resolve({found: false, attempts: attempts});
                }
            }
            
            checkForLoginForm();
        });
        """
        
        try:
            result = driver.execute_async_script(wait_script)
            return result
        except Exception as e:
            print(f"JavaScript ÎåÄÍ∏∞ Ïò§Î•ò: {e}")
            return {"found": False, "error": str(e)}
    
    def login_to_metabase(self, driver, base_url, username, password):
        """ÎèôÏ†Å Î†åÎçîÎßÅÏùÑ Í≥†Î†§Ìïú Metabase Î°úÍ∑∏Ïù∏"""
        login_url = f"{base_url}/auth/login"
        print(f"üîó Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄ Ï†ëÏÜç: {login_url}")
        
        driver.get(login_url)
        print(f"üìç ÌòÑÏû¨ URL: {driver.current_url}")
        
        # ÎèôÏ†Å ÏöîÏÜå Î°úÎî© ÎåÄÍ∏∞
        form_result = self.wait_for_dynamic_elements(driver)
        
        if not form_result.get("found"):
            print("‚ùå Î°úÍ∑∏Ïù∏ ÌèºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå")
            driver.save_screenshot("login_form_not_found.png")
            return False
        
        print(f"‚úÖ Î°úÍ∑∏Ïù∏ Ìèº Î∞úÍ≤¨: {form_result.get('selector')}")
        
        # Username ÌïÑÎìú Ï∞æÍ∏∞ Î∞è ÏûÖÎ†•
        username_selectors = [
            (By.NAME, "username"),
            (By.NAME, "email"),
            (By.CSS_SELECTOR, "input[type='text']"),
            (By.CSS_SELECTOR, "input[type='email']"),
            (By.CSS_SELECTOR, "input[placeholder*='username' i]"),
            (By.CSS_SELECTOR, "input[placeholder*='email' i]")
        ]
        
        username_element = None
        for selector_type, selector_value in username_selectors:
            try:
                username_element = WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((selector_type, selector_value))
                )
                print(f"‚úÖ Username ÌïÑÎìú Î∞úÍ≤¨: {selector_type.name}='{selector_value}'")
                break
            except TimeoutException:
                continue
        
        if not username_element:
            print("‚ùå Username ÌïÑÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå")
            return False
        
        # Password ÌïÑÎìú Ï∞æÍ∏∞
        try:
            password_element = WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable((By.CSS_SELECTOR, "input[type='password']"))
            )
            print("‚úÖ Password ÌïÑÎìú Î∞úÍ≤¨")
        except TimeoutException:
            print("‚ùå Password ÌïÑÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå")
            return False
        
        # Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÏûÖÎ†•
        print("üîë Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÏûÖÎ†• Ï§ë...")
        username_element.clear()
        username_element.send_keys(username)
        
        password_element.clear()
        password_element.send_keys(password)
        
        # Î°úÍ∑∏Ïù∏ ÏãúÎèÑ
        try:
            submit_button = WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable((By.CSS_SELECTOR, "button[type='submit']"))
            )
            submit_button.click()
            print("‚úÖ Î°úÍ∑∏Ïù∏ Î≤ÑÌäº ÌÅ¥Î¶≠")
        except TimeoutException:
            # Enter ÌÇ§Î°ú ÎåÄÏ≤¥ ÏãúÎèÑ
            password_element.send_keys("\n")
            print("‚úÖ Enter ÌÇ§Î°ú Î°úÍ∑∏Ïù∏ ÏãúÎèÑ")
        
        # Î°úÍ∑∏Ïù∏ ÏôÑÎ£å ÎåÄÍ∏∞
        time.sleep(5)
        
        # Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ ÌôïÏù∏
        if "/auth/login" not in driver.current_url:
            print(f"‚úÖ Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ - ÌòÑÏû¨ URL: {driver.current_url}")
            return True
        else:
            print("‚ùå Î°úÍ∑∏Ïù∏ Ïã§Ìå® - Ïó¨Ï†ÑÌûà Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÏóê ÏûàÏùå")
            driver.save_screenshot("login_failed.png")
            return False
    
    def wait_for_question_load(self, driver, wait_seconds=10):
        """Question ÌéòÏù¥ÏßÄÏùò Ï∞®Ìä∏ Î°úÎî© ÏôÑÎ£å ÎåÄÍ∏∞"""
        print("‚è≥ Question Ï∞®Ìä∏ Î°úÎî© ÎåÄÍ∏∞ Ï§ë...")
        
        # Ï∞®Ìä∏ Í¥ÄÎ†® ÏöîÏÜåÎì§Ïù¥ ÎÇòÌÉÄÎÇ† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
        chart_selectors = [
            ".Visualization",
            "[data-testid='query-visualization-root']", 
            ".QueryBuilder-section",
            ".Card .Card-content",
            "svg", # ÎßéÏùÄ Ï∞®Ìä∏Í∞Ä SVGÎ°ú Î†åÎçîÎßÅÎê®
            "canvas" # ÏùºÎ∂Ä Ï∞®Ìä∏Îäî Canvas ÏÇ¨Ïö©
        ]
        
        chart_found = False
        for selector in chart_selectors:
            try:
                WebDriverWait(driver, 15).until(
                    EC.presence_of_element_located((By.CSS_SELECTOR, selector))
                )
                print(f"‚úÖ Ï∞®Ìä∏ ÏöîÏÜå Î∞úÍ≤¨: {selector}")
                chart_found = True
                break
            except TimeoutException:
                continue
        
        if not chart_found:
            print("‚ö†Ô∏è Ï∞®Ìä∏ ÏöîÏÜåÎ•º Ï∞æÏßÄ Î™ªÌñàÏßÄÎßå Í≥ÑÏÜç ÏßÑÌñâ")
        
        # Î°úÎî© Ïä§ÌîºÎÑàÍ∞Ä ÏÇ¨ÎùºÏßà ÎïåÍπåÏßÄ ÎåÄÍ∏∞
        try:
            WebDriverWait(driver, 10).until_not(
                EC.presence_of_element_located((By.CSS_SELECTOR, ".Loading, .LoadingSpinner, [data-testid='loading-spinner']"))
            )
            print("‚úÖ Î°úÎî© ÏôÑÎ£å")
        except TimeoutException:
            print("‚ö†Ô∏è Î°úÎî© Ïä§ÌîºÎÑà ÌôïÏù∏ Ïã§Ìå®, Ï∂îÍ∞Ä ÎåÄÍ∏∞")
        
        # Ï∂îÍ∞Ä ÏïàÏ†Ñ ÎåÄÍ∏∞
        time.sleep(wait_seconds)
        
        # JavaScript Ïã§ÌñâÏúºÎ°ú Î†åÎçîÎßÅ ÏôÑÎ£å ÌôïÏù∏
        try:
            is_ready = driver.execute_script("""
                // Ï∞®Ìä∏Í∞Ä Ïã§Ï†úÎ°ú Î†åÎçîÎßÅÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                const charts = document.querySelectorAll('svg, canvas, .Visualization');
                return charts.length > 0;
            """)
            
            if is_ready:
                print("‚úÖ Ï∞®Ìä∏ Î†åÎçîÎßÅ ÌôïÏù∏ ÏôÑÎ£å")
            else:
                print("‚ö†Ô∏è Ï∞®Ìä∏ Î†åÎçîÎßÅ ÌôïÏù∏ Ïã§Ìå®")
        except Exception as e:
            print(f"‚ö†Ô∏è JavaScript Î†åÎçîÎßÅ ÌôïÏù∏ Ïò§Î•ò: {e}")
    
    def capture_question_chart(self, driver):
        """Question ÌéòÏù¥ÏßÄÏóêÏÑú Ï∞®Ìä∏ ÏòÅÏó≠Îßå Ï∫°Ï≤ò"""
        try:
            # Îã§ÏñëÌïú Ï∞®Ìä∏ ÏÑ†ÌÉùÏûê ÏãúÎèÑ
            chart_selectors = [
                ".Visualization",
                "[data-testid='query-visualization-root']",
                ".QueryBuilder-section .Card",
                ".Card .Card-content",
                ".Question .Card"
            ]
            
            chart_element = None
            for selector in chart_selectors:
                try:
                    elements = driver.find_elements(By.CSS_SELECTOR, selector)
                    for element in elements:
                        if element.is_displayed() and element.size['width'] > 100 and element.size['height'] > 100:
                            chart_element = element
                            print(f"‚úÖ Ï∞®Ìä∏ ÏöîÏÜå ÏÑ†ÌÉù: {selector}")
                            break
                    if chart_element:
                        break
                except Exception as e:
                    continue
            
            if chart_element:
                return chart_element.screenshot_as_png
            else:
                print("‚ö†Ô∏è Ï∞®Ìä∏ ÏöîÏÜåÎ•º Ï∞æÏßÄ Î™ªÌï¥ Ï†ÑÏ≤¥ ÌéòÏù¥ÏßÄ Ï∫°Ï≤ò")
                return driver.get_screenshot_as_png()
                
        except Exception as e:
            print(f"‚ö†Ô∏è Ï∞®Ìä∏ Ï∫°Ï≤ò Ïã§Ìå®, Ï†ÑÏ≤¥ ÌéòÏù¥ÏßÄ Ï∫°Ï≤ò: {e}")
            return driver.get_screenshot_as_png()
    
    def capture_question(self, question_url, username, password, wait_seconds=10, crop_to_chart=True):
        """Question URLÏùÑ PNGÎ°ú Ï∫°Ï≤ò"""
        driver = webdriver.Chrome(options=self.chrome_options)
        
        try:
            # Metabase Í∏∞Î≥∏ URL Ï∂îÏ∂ú
            base_url = question_url.split('/question')[0]
            print(f"üè† Metabase Í∏∞Î≥∏ URL: {base_url}")
            
            # Î°úÍ∑∏Ïù∏
            if not self.login_to_metabase(driver, base_url, username, password):
                raise Exception("Î°úÍ∑∏Ïù∏ Ïã§Ìå®")
            
            # Question ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
            print(f"üìä Question ÌéòÏù¥ÏßÄ Ïù¥Îèô: {question_url}")
            driver.get(question_url)
            
            # Ï∞®Ìä∏ Î°úÎî© ÏôÑÎ£å ÎåÄÍ∏∞
            self.wait_for_question_load(driver, wait_seconds)
            
            # Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï∫°Ï≤ò
            if crop_to_chart:
                screenshot_png = self.capture_question_chart(driver)
            else:
                screenshot_png = driver.get_screenshot_as_png()
            
            print("‚úÖ Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï∫°Ï≤ò ÏôÑÎ£å")
            return screenshot_png
                
        except Exception as e:
            print(f"‚ùå Ï∫°Ï≤ò Ïã§Ìå®: {e}")
            driver.save_screenshot("capture_error.png")
            raise
        finally:
            driver.quit()

# ÏÑúÎπÑÏä§ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
screenshot_service = MetabaseScreenshotService()

@app.route('/screenshot', methods=['POST'])
def take_screenshot():
    """Question URLÏùÑ PNGÎ°ú Î≥ÄÌôòÌïòÎäî API"""
    try:
        data = request.json
        question_url = data.get('question_url')
        username = data.get('username')
        password = data.get('password')
        wait_seconds = data.get('wait_seconds', 10)
        crop_to_chart = data.get('crop_to_chart', True)
        return_base64 = data.get('return_base64', True)
        
        if not all([question_url, username, password]):
            return jsonify({
                "success": False,
                "error": "question_url, username, password are required"
            }), 400
        
        print(f"üìã Ïä§ÌÅ¨Î¶∞ÏÉ∑ ÏöîÏ≤≠:")
        print(f"   - URL: {question_url}")
        print(f"   - Username: {username}")
        print(f"   - Wait: {wait_seconds}s")
        print(f"   - Crop: {crop_to_chart}")
        
        # Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï∫°Ï≤ò
        screenshot_png = screenshot_service.capture_question(
            question_url=question_url,
            username=username,
            password=password,
            wait_seconds=wait_seconds,
            crop_to_chart=crop_to_chart
        )
        
        if return_base64:
            # Base64Î°ú Î∞òÌôò
            image_base64 = base64.b64encode(screenshot_png).decode()
            return jsonify({
                "success": True,
                "image_base64": image_base64,
                "timestamp": datetime.now().isoformat(),
                "question_url": question_url
            })
        else:
            # Î∞îÏù¥ÎÑàÎ¶¨ ÌååÏùºÎ°ú Î∞òÌôò
            return send_file(
                io.BytesIO(screenshot_png),
                mimetype='image/png',
                as_attachment=True,
                download_name=f'metabase_question_{int(time.time())}.png'
            )
            
    except Exception as e:
        print(f"‚ùå API Ïò§Î•ò: {e}")
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

@app.route('/health', methods=['GET'])
def health_check():
    """ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏"""
    return jsonify({
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "service": "Metabase Screenshot Service"
    })

@app.route('/test', methods=['POST'])
def test_login():
    """Î°úÍ∑∏Ïù∏ ÌÖåÏä§Ìä∏Ïö© ÏóîÎìúÌè¨Ïù∏Ìä∏"""
    try:
        data = request.json
        base_url = data.get('base_url')
        username = data.get('username')
        password = data.get('password')
        
        driver = webdriver.Chrome(options=screenshot_service.chrome_options)
        
        try:
            result = screenshot_service.login_to_metabase(driver, base_url, username, password)
            
            return jsonify({
                "success": result,
                "message": "Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ" if result else "Î°úÍ∑∏Ïù∏ Ïã§Ìå®",
                "current_url": driver.current_url
            })
            
        finally:
            driver.quit()
            
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

if __name__ == '__main__':
    print("üöÄ Metabase Screenshot Service ÏãúÏûë")
    print("üìã ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏóîÎìúÌè¨Ïù∏Ìä∏:")
    print("   POST /screenshot - Question URLÏùÑ PNGÎ°ú Î≥ÄÌôò")
    print("   POST /test - Î°úÍ∑∏Ïù∏ ÌÖåÏä§Ìä∏")
    print("   GET /health - ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏")
    print("üåê ÏÑúÎ≤Ñ ÏãúÏûë: http://0.0.0.0:5000")
    
    app.run(host='0.0.0.0', port=5000, debug=False)
